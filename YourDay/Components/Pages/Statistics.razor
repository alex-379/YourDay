@page "/manager-statistics"
@attribute [StreamRendering]
@inject NavigationManager NavigationWorker

<GetClaims SendIsCompleted="b=>_isCompleted=b" SendRole="p=>_role=p"></GetClaims>

@if (_isCompleted && _role != RoleUI.Manager.ToString())
{
    <ReturnToStart></ReturnToStart>
}
else
{
    <PageTitle>Cтатистика</PageTitle>

    <div>
        <h2 class="manager-h1">Здесь вы можете посмотреть статистику по всей компании:</h2>
    </div>

    <table>
        <thead>
            @foreach (Column column in Columns)
            {
            <th>
                    @column.LayoutHeader
            </th>
            }
        </thead>
        <tbody>
            @foreach (CompanyStatisticOutputModel outputModel in _model)
            {
                <tr>
                    @foreach (Column column in Columns)
                    {
                        <td>
                            @typeof(CompanyStatisticOutputModel).GetProperty(column.Field).GetValue(outputModel)
                        </td>
                    }
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private string? _role;

    private bool _isCompleted;

    private IEnumerable<CompanyStatisticOutputModel> _model;

    private IManagerService _statistics;

    private List<Column> Columns { get; set; }

    class Column
    {
        public string Field { get; set; }
        public string LayoutHeader { get; set; }
    }

    public Statistics()
    {
        _model = new List<CompanyStatisticOutputModel>();
        _statistics = new ManagerService();
        Columns = new List<Column>();
    }

    protected override async Task OnInitializedAsync()
    {
        if (_role == RoleUI.Manager.ToString())
        {
            Columns = new List<Column>();

            Columns.AddRange(
                new Column[]
                {
                    new Column()
                {
                    Field="IdManager",
                    LayoutHeader="Индификатор менеджера"
                },
                new Column()
                {
                    Field="NameManager",
                    LayoutHeader="Имя менеджера"
                },
                new Column()
                {
                    Field="IdOrder",
                    LayoutHeader="Индификатор заказа"
                },
                new Column()
                {
                    Field="TitleOrder",
                    LayoutHeader="Название заказа"
                },
                new Column()
                {
                    Field="IdTask",
                    LayoutHeader="Индификатор задачи"
                },
                new Column()
                {
                    Field="TitleTask",
                    LayoutHeader="название задачи"
                }

                });

            _model = await _statistics.GetAllTaskOfOrderOfTheirManager();
        }
    }
}
